

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Louvain Parallel Extension &mdash; CHAMP 1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="CHAMP 1 documentation" href="../index.html"/>
        <link rel="prev" title="Visualizing Results" href="plotting2.html"/> 

  
  <script src="js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> CHAMP
          

          
          </a>

          
            
            
              <div class="version">
                1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">CHAMP (Convex Hull of Admissible Modularity Partitions)</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="running.html">Running CHAMP</a></li>
<li class="toctree-l1"><a class="reference internal" href="plotting2.html">Visualizing Results</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Louvain Parallel Extension</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#partition-ensemble-example">Partition Ensemble Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-and-managing-large-partition-sets">Creating and Managing Large Partition Sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#saving-and-loading-partitionensembles">Saving and Loading PartitionEnsembles</a></li>
<li class="toctree-l2"><a class="reference internal" href="#merging-partitionensembles">Merging PartitionEnsembles</a></li>
<li class="toctree-l2"><a class="reference internal" href="#improvement-with-hdf5-saving-and-loading">Improvement with HDF5 saving and loading</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CHAMP</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Louvain Parallel Extension</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/_static/louvain_ext.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="louvain-parallel-extension">
<span id="louvain-ext"></span><h1>Louvain Parallel Extension<a class="headerlink" href="#louvain-parallel-extension" title="Permalink to this headline">¶</a></h1>
<p>CHAMP can be used with partitions generated by any community detection algorithm.  One of the most popular and fast algorithms is known as Louvain <a class="reference internal" href="#blondel-2008vn" id="id1">[1]</a> .  We provide an extension to the python package developed by Vincent Traag, <a class="reference external" href="https://github.com/vtraag/louvain-igraph">louvain_igraph</a>  <a class="reference internal" href="#traag-louvain" id="id2">[2]</a> to run Louvain in parallel, while calculating the coefficients necessary for CHAMP.  Currently, this extension only support single-layer network.  The random seed is set within each parallel process to ensure that the results are
stochastic over each run.  In general this is desireable because Louvain uses a greedy optimization schema that finds <em>local</em> optima.</p>
<p>We also have created a convenient class for managing and merging groups of partitions called <code class="xref py py-mod docutils literal"><span class="pre">champ.PartitionEnsemble</span></code> .  This class stores the partitions in membership vector form ( i.e. a list of N community assignments), as well as the coefficients for the partitions.  As part of its constructor, the PartitionEnsemble applies CHAMP to all of its partitions, and stores the domains of dominance.</p>
<div class="section" id="partition-ensemble-example">
<h2>Partition Ensemble Example<a class="headerlink" href="#partition-ensemble-example" title="Permalink to this headline">¶</a></h2>
<p>We use igraph to generate a random ER graph, call louvain in parallel, and apply CHAMP to the ensemble.  This example took approximately 1 minute to run on 2 cores.  We can use the PartitionEnsemble object to check whether all of the coefficients are unique, and to check whether all of the partitions themselve are unique (it is possible for two unique
partitions to give rise to the same coefficients).</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">champ</span>
<span class="kn">import</span> <span class="nn">igraph</span> <span class="k">as</span> <span class="nn">ig</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_graph</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">Graph</span><span class="o">.</span><span class="n">Erdos_Renyi</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="n">p</span><span class="o">=.</span><span class="mi">05</span><span class="p">)</span>
<span class="c1">#Create temporary file for calling louvain</span>
<span class="n">tfile</span><span class="o">=</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span>
<span class="n">test_graph</span><span class="o">.</span><span class="n">write_graphmlz</span><span class="p">(</span><span class="n">tfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="c1"># non-parallelized wrapper</span>
<span class="n">ens1</span><span class="o">=</span><span class="n">champ</span><span class="o">.</span><span class="n">run_louvain</span><span class="p">(</span><span class="n">tfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">nruns</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># parallelized wrapper</span>
<span class="n">test_graph2</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">Graph</span><span class="o">.</span><span class="n">Random_Bipartite</span><span class="p">(</span><span class="n">n1</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">n2</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">p</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ens2</span><span class="o">=</span><span class="n">champ</span><span class="o">.</span><span class="n">parallel_louvain</span><span class="p">(</span><span class="n">test_graph2</span><span class="p">,</span>
                                  <span class="n">numruns</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">fin</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">maxpt</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                  <span class="n">numprocesses</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                  <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2"> partitions are unique&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ens2</span><span class="o">.</span><span class="n">unique_partition_indices</span><span class="p">),</span><span class="n">ens2</span><span class="o">.</span><span class="n">numparts</span><span class="p">))</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2"> partitions after application of CHAMP&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ens2</span><span class="o">.</span><span class="n">ind2doms</span><span class="p">),</span><span class="n">ens2</span><span class="o">.</span><span class="n">numparts</span><span class="p">))</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Number of twin sets:&quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">ens2</span><span class="o">.</span><span class="n">twin_partitions</span><span class="p">)</span>
<span class="c1">#plot both of these</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">f</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">a3</span><span class="o">=</span><span class="n">a</span>
<span class="n">champ</span><span class="o">.</span><span class="n">plot_single_layer_modularity_domains</span><span class="p">(</span><span class="n">ens2</span><span class="o">.</span><span class="n">ind2doms</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">a1</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">champ</span><span class="o">.</span><span class="n">plot_similarity_heatmap_single_layer</span><span class="p">(</span><span class="n">ens2</span><span class="o">.</span><span class="n">partitions</span><span class="p">,</span><span class="n">ens2</span><span class="o">.</span><span class="n">ind2doms</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">a2</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#PartitionEnsemble has method to plot downsampled summary of all partitions</span>
<span class="c1">#with optmal transitions and number of communities overlayed.</span>

<span class="n">ens2</span><span class="o">.</span><span class="n">plot_modularity_mapping</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">a3</span><span class="p">,</span><span class="n">no_tex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>Output:</p>
<div class="line-block">
<div class="line">Run 0 at gamma = 0.000.  Return time: 0.0264</div>
<div class="line">Run 200 at gamma = 0.800.  Return time: 0.0621</div>
<div class="line">Run 100 at gamma = 0.400.  Return time: 0.0589</div>
<div class="line">Run 300 at gamma = 1.200.  Return time: 0.0660</div>
<div class="line">Run 400 at gamma = 1.600.  Return time: 0.0963</div>
<div class="line">Run 500 at gamma = 2.000.  Return time: 0.0970</div>
<div class="line">Run 600 at gamma = 2.400.  Return time: 0.0828</div>
<div class="line">Run 700 at gamma = 2.800.  Return time: 0.0769</div>
<div class="line">Run 800 at gamma = 3.200.  Return time: 0.0763</div>
<div class="line">Run 900 at gamma = 3.600.  Return time: 0.0818</div>
<div class="line">847 of 1000 partitions are unique</div>
<div class="line">11 of 1000 partitions after application of CHAMP</div>
<div class="line">Number of twin sets:</div>
<div class="line-block">
<div class="line">[]</div>
<div class="line"><br /></div>
</div>
</div>
<p>We see that there are a number of identical partitions here, there are no twin partitions .  That is different partitions with the same coefficents.</p>
<a class="reference internal image-reference" href="../_images/part_ens_exp.png" id="part-ens-exp"><img alt="../_images/part_ens_exp.png" id="part-ens-exp" src="../_images/part_ens_exp.png" style="width: 90%;" /></a>
</div>
<div class="section" id="creating-and-managing-large-partition-sets">
<h2>Creating and Managing Large Partition Sets<a class="headerlink" href="#creating-and-managing-large-partition-sets" title="Permalink to this headline">¶</a></h2>
<p>For large sets of partitions on larger networks, loading the entire set of partitions each time you want to access the data can take a fair amount of time.  Having to load all of the partitions defeats the purpose of using CHAMP to find the optimal subset.  As such we have equiped <code class="xref py py-mod docutils literal"><span class="pre">champ.louvain_ext.PartitionEnsemble</span></code> objects with the ability to write to and access hdf5 files.  Instead of loading the entire set of partitions each time, only the coefficients, the domains of dominance, the underlying graph information is loaded, vastly reducing the
loading time and the memory required for large numbers of runs. Each individual partitions ( or all partitions at once) can be access from file only if needed, as the example below illustrates:</p>
</div>
<div class="section" id="saving-and-loading-partitionensembles">
<h2>Saving and Loading PartitionEnsembles<a class="headerlink" href="#saving-and-loading-partitionensembles" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">champ</span>
<span class="kn">import</span> <span class="nn">igraph</span> <span class="k">as</span> <span class="nn">ig</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_graph</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">Graph</span><span class="o">.</span><span class="n">Erdos_Renyi</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">p</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>
<span class="n">times</span><span class="o">=</span><span class="p">{}</span>
<span class="n">run_nums</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span>

<span class="c1">#saving ensemble</span>
<span class="n">ensemble</span><span class="o">=</span><span class="n">champ</span><span class="o">.</span><span class="n">parallel_louvain</span><span class="p">(</span><span class="n">test_graph</span><span class="p">,</span><span class="n">numprocesses</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">numruns</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">fin</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">maxpt</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;Ensemble 1, Optimal subset is </span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2"> partitions&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">ind2doms</span><span class="p">),</span><span class="n">ensemble</span><span class="o">.</span><span class="n">numparts</span><span class="p">)</span>
<span class="n">ensemble</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;ensemble1.hdf5&quot;</span><span class="p">,</span><span class="n">hdf5</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#openning created file</span>
<span class="n">ensemble2</span><span class="o">=</span><span class="n">champ</span><span class="o">.</span><span class="n">PartitionEnsemble</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;ensemble1.hdf5&quot;</span><span class="p">)</span>
<span class="c1">#partitions is an internal class the handles access</span>
<span class="nb">print</span> <span class="n">ensemble2</span><span class="o">.</span><span class="n">partitions</span>
<span class="c1">#When sliced a numpy.array is returned</span>
<span class="nb">print</span> <span class="s2">&quot;ensemble2.partitions[38,:10]:</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">ensemble2</span><span class="o">.</span><span class="n">partitions</span><span class="p">[</span><span class="mi">38</span><span class="p">:</span><span class="mi">40</span><span class="p">,:</span><span class="mi">10</span><span class="p">]</span>

<span class="c1">#You can still add partitions as normal.  These are automatically</span>
<span class="c1">#added to the hdf5 file</span>
<span class="n">ensemble2add</span><span class="o">=</span><span class="n">champ</span><span class="o">.</span><span class="n">parallel_louvain</span><span class="p">(</span><span class="n">test_graph</span><span class="p">,</span><span class="n">numprocesses</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">numruns</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">fin</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">maxpt</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ensemble2</span><span class="o">.</span><span class="n">add_partitions</span><span class="p">(</span><span class="n">ensemble2add</span><span class="o">.</span><span class="n">get_partition_dictionary</span><span class="p">())</span>
<span class="nb">print</span> <span class="s2">&quot;ensemble 2 has </span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2"> partitions dominant&quot;</span>  <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble2</span><span class="o">.</span><span class="n">ind2doms</span><span class="p">),</span><span class="n">ensemble2</span><span class="o">.</span><span class="n">numparts</span><span class="p">)</span>

<span class="c1">#When open is called, the created EnsemblePartition assumes all</span>
<span class="c1">#the state variables of saved EnsemblePartition, including default save file.</span>
<span class="c1">#If save() is called, it will overwrite the old ensemble file</span>
<span class="nb">print</span> <span class="s2">&quot;ensemble2 default hdf5 file: &quot;</span><span class="p">,</span><span class="n">ensemble2</span><span class="o">.</span><span class="n">hdf5_file</span>
</pre></div>
</div>
<p>Output:</p>
<div class="line-block">
<div class="line">Ensemble 1, Optimal subset is 11 of 200 partitions</div>
<div class="line">200 partitions saved on ensemble1.hdf5</div>
<div class="line">ensemble2.partitions[38,:10]:</div>
<div class="line"><br /></div>
<div class="line-block">
<div class="line">[[1 0 1 0 0 0 0 0 1 1]</div>
<div class="line">[1 1 2 0 1 0 2 1 2 1]]</div>
<div class="line"><br /></div>
</div>
<div class="line">ensemble 2 has 12 of 300 partitions dominant</div>
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<p>You can see with the above example that CHAMP is reapplied everytime new partitions are added to the PartitionEnsemble instance.  In addition, whole PartitionEnsemble objects can be merged together in a similar fashion.  You can either have a new PartitionEnsemble generated, containing the contents of both the inputs.  Or one partition can be merged into the other one.  It automatically uses the larger of the two to merge into.  In addition, if either PartitionEnsemble has an associated hdf5 file, the merger will just expand the contents of the file and keep the same PartitionEnsemble object.</p>
</div>
<div class="section" id="merging-partitionensembles">
<h2>Merging PartitionEnsembles<a class="headerlink" href="#merging-partitionensembles" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">champ</span>
<span class="kn">import</span> <span class="nn">igraph</span> <span class="k">as</span> <span class="nn">ig</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_graph</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">Graph</span><span class="o">.</span><span class="n">Erdos_Renyi</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">p</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>
<span class="n">times</span><span class="o">=</span><span class="p">{}</span>
<span class="n">run_nums</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span>

<span class="n">ensemble</span><span class="o">=</span><span class="n">champ</span><span class="o">.</span><span class="n">parallel_louvain</span><span class="p">(</span><span class="n">test_graph</span><span class="p">,</span><span class="n">numprocesses</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">numruns</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">fin</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">maxpt</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;Ensemble 1, Optimal subset is </span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2"> partitions&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">ind2doms</span><span class="p">),</span><span class="n">ensemble</span><span class="o">.</span><span class="n">numparts</span><span class="p">)</span>
<span class="n">ensemble</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;ensemble1.hdf5&quot;</span><span class="p">,</span><span class="n">hdf5</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ensemble2</span><span class="o">=</span><span class="n">champ</span><span class="o">.</span><span class="n">parallel_louvain</span><span class="p">(</span><span class="n">test_graph</span><span class="p">,</span><span class="n">numprocesses</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">numruns</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">fin</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">maxpt</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;Ensemble 2, Optimal subset is </span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2"> partitions&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble2</span><span class="o">.</span><span class="n">ind2doms</span><span class="p">),</span><span class="n">ensemble2</span><span class="o">.</span><span class="n">numparts</span><span class="p">)</span>
<span class="n">ensemble2</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;ensemble2.hdf5&quot;</span><span class="p">,</span><span class="n">hdf5</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#Esembles can be merged as follows:</span>

<span class="c1">#Create new PartitionEnsemble from scratch</span>
<span class="n">ensemble3</span><span class="o">=</span><span class="n">ensemble</span><span class="o">.</span><span class="n">merge_ensemble</span><span class="p">(</span><span class="n">ensemble2</span><span class="p">,</span><span class="n">new</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;Ensemble 3, Optimal subset is </span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2"> partitions&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble3</span><span class="o">.</span><span class="n">ind2doms</span><span class="p">),</span><span class="n">ensemble3</span><span class="o">.</span><span class="n">numparts</span><span class="p">)</span>

<span class="c1">#Use largest of the 2 PartitionEnsembles being merged  and modify</span>
<span class="n">ensemble4</span><span class="o">=</span><span class="n">ensemble</span><span class="o">.</span><span class="n">merge_ensemble</span><span class="p">(</span><span class="n">ensemble3</span><span class="p">,</span><span class="n">new</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;Ensemble 4, Optimal subset is </span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2"> partitions&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble4</span><span class="o">.</span><span class="n">ind2doms</span><span class="p">),</span><span class="n">ensemble4</span><span class="o">.</span><span class="n">numparts</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;ensemble4 is ensemble3: &quot;</span><span class="p">,</span><span class="n">ensemble4</span> <span class="ow">is</span> <span class="n">ensemble3</span>
</pre></div>
</div>
<p>Output:</p>
<div class="line-block">
<div class="line">Ensemble 1, Optimal subset is 13 of 200 partitions</div>
<div class="line">Ensemble 2, Optimal subset is 15 of 200 partitions</div>
<div class="line">Ensemble 3, Optimal subset is 15 of 400 partitions</div>
<div class="line">Ensemble 4, Optimal subset is 15 of 600 partitions</div>
<div class="line">ensemble4 is ensemble3:  True</div>
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="improvement-with-hdf5-saving-and-loading">
<h2>Improvement with HDF5 saving and loading<a class="headerlink" href="#improvement-with-hdf5-saving-and-loading" title="Permalink to this headline">¶</a></h2>
<p>The following example gives a sense of when it is beneficial to save as HDF5 and general runtimes for parallelized Louvain.  We also found that the overhead is dependent on the size of the graph as well, so that for larger graphs with a lower number of partitions, the read/write time on HDF5 can be greater.  Total runtime was about 2.5 hours on 10 CPUs.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">champ</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sbn</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">igraph</span> <span class="k">as</span> <span class="nn">ig</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_graph</span><span class="o">=</span><span class="n">ig</span><span class="o">.</span><span class="n">Graph</span><span class="o">.</span><span class="n">Erdos_Renyi</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">p</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>

<span class="n">times</span><span class="o">=</span><span class="p">{}</span>
<span class="n">run_nums</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">2000</span><span class="p">,</span><span class="mi">3000</span><span class="p">,</span><span class="mi">10000</span><span class="p">]</span>

<span class="k">for</span> <span class="n">nrun</span> <span class="ow">in</span> <span class="n">run_nums</span> <span class="p">:</span>
    <span class="n">rtimes</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">t</span><span class="o">=</span><span class="n">time</span><span class="p">()</span>
    <span class="n">ens</span><span class="o">=</span><span class="n">champ</span><span class="o">.</span><span class="n">parallel_louvain</span><span class="p">(</span><span class="n">test_graph</span><span class="p">,</span><span class="n">numprocesses</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">numruns</span><span class="o">=</span><span class="n">nrun</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">fin</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">maxpt</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ens</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;name&#39;</span>
    <span class="n">rtimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>

    <span class="c1">#normal save (gzip)</span>
    <span class="nb">print</span> <span class="s2">&quot;CHAMP running time </span><span class="si">%d</span><span class="s2"> runs: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">nrun</span><span class="p">,</span><span class="n">rtimes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">t</span><span class="o">=</span><span class="n">time</span><span class="p">()</span>
    <span class="n">ens</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">rtimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="o">=</span><span class="n">time</span><span class="p">()</span>

    <span class="c1">#normal open</span>
    <span class="n">t</span><span class="o">=</span><span class="n">time</span><span class="p">()</span>
    <span class="n">newens</span><span class="o">=</span><span class="n">champ</span><span class="o">.</span><span class="n">PartitionEnsemble</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;name_PartEnsemble_</span><span class="si">%d</span><span class="s2">.gz&quot;</span><span class="o">%</span><span class="n">nrun</span><span class="p">)</span>
    <span class="n">rtimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="o">=</span><span class="n">time</span><span class="p">()</span>

    <span class="c1">#save with h5py</span>
    <span class="n">t</span><span class="o">=</span><span class="n">time</span><span class="p">()</span>
    <span class="n">ens</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">hdf5</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">rtimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="o">=</span><span class="n">time</span><span class="p">()</span>

    <span class="c1">#open with hdf5 format</span>
    <span class="n">t</span><span class="o">=</span><span class="n">time</span><span class="p">()</span>
    <span class="n">newes</span><span class="o">=</span><span class="n">champ</span><span class="o">.</span><span class="n">PartitionEnsemble</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;name_PartEnsemble_</span><span class="si">%d</span><span class="s2">.hdf5&quot;</span><span class="o">%</span><span class="n">nrun</span><span class="p">)</span>
    <span class="n">rtimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
    <span class="n">times</span><span class="p">[</span><span class="n">nrun</span><span class="p">]</span><span class="o">=</span><span class="n">rtimes</span>

<span class="n">tab</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">times</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">run_nums</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;runtime&#39;</span><span class="p">,</span><span class="s1">&#39;save&#39;</span><span class="p">,</span><span class="s1">&#39;load&#39;</span><span class="p">,</span><span class="s1">&#39;hdf5save&#39;</span><span class="p">,</span><span class="s1">&#39;hdf5load&#39;</span><span class="p">])</span>
<span class="n">colors</span><span class="o">=</span><span class="n">sbn</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s1">&#39;Set1&#39;</span><span class="p">,</span><span class="n">n_colors</span><span class="o">=</span><span class="n">tab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">f</span><span class="p">,(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">)</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ind</span><span class="o">==</span><span class="s1">&#39;runtime&#39;</span><span class="p">:</span>
        <span class="n">a1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span><span class="n">tab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,:],</span><span class="n">label</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span><span class="n">tab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,:],</span><span class="n">label</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">a1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;#partitions&quot;</span><span class="p">)</span>
<span class="n">a1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;seconds&quot;</span><span class="p">)</span>
<span class="n">a2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;#partitions&quot;</span><span class="p">)</span>
<span class="n">a2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;seconds&quot;</span><span class="p">)</span>

<span class="n">a2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Comparison of Save and Load Times&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">a1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Runtimes on random ER-graph G(N=1000,p=.1)&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">a1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">a2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>Output:</p>
<div class="line-block">
<div class="line">CHAMP running time 100 runs: 53.771</div>
<div class="line">CHAMP running time 1000 runs: 498.642</div>
<div class="line">CHAMP running time 2000 runs: 988.658</div>
<div class="line">CHAMP running time 3000 runs: 1479.512</div>
<div class="line">CHAMP running time 10000 runs: 5091.727</div>
<div class="line"><br /></div>
</div>
<a class="reference internal image-reference" href="../_images/runtime_ex.png" id="runtime-exp"><img alt="../_images/runtime_ex.png" id="runtime-exp" src="../_images/runtime_ex.png" style="width: 90%;" /></a>
<div class="section" id="references">
<h3>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h3>
<p id="bibtex-bibliography-_static/louvain_ext-0"><table class="docutils citation" frame="void" id="blondel-2008vn" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Vincent&nbsp;D Blondel, Jean-Loup Guillaume, Renaud Lambiotte, and Etienne Lefebvre. Fast unfolding of communities in large networks. <em>Journal of Statistical Mechanics: Theory and Experiment</em>, pages P10008, 2008.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="traag-louvain" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Vincent Traag. Louvain igraph. <span><a class="reference external" href="#"></a></span>http://github.com/vtraag/louvain-igraph.</td></tr>
</tbody>
</table>
</p>
<ul class="simple">
<li><a class="reference internal" href="../genindex.html"><span class="std std-ref">Index</span></a></li>
<li><a class="reference internal" href="../search.html"><span class="std std-ref">Search Page</span></a></li>
</ul>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="plotting2.html" class="btn btn-neutral" title="Visualizing Results" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, William Weir.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="jquery.js"></script>
      <script type="text/javascript" src="underscore.js"></script>
      <script type="text/javascript" src="doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>